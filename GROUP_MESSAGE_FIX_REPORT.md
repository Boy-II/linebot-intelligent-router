# LINE Bot ç¾¤çµ„è¨Šæ¯è™•ç†ä¿®å¾©å ±å‘Š

## ğŸš¨ å•é¡Œæè¿°

**åŸå§‹å•é¡Œ**: LINE Bot åœ¨ç¾¤çµ„ï¼ˆé »é“ï¼‰ä¸­ï¼Œå³ä½¿æœªè¢« tag/mention çš„æƒ…æ³ä¸‹ï¼Œä¹Ÿæœƒè§¸ç™¼è¨»å†Šæµç¨‹ï¼Œå°æ‰€æœ‰ç¾¤çµ„æˆå“¡é€ æˆå¹²æ“¾ã€‚

## ğŸ” å•é¡Œæ ¹å› åˆ†æ

1. **ç¼ºä¹ç¾¤çµ„è¨Šæ¯éæ¿¾**: åŸå§‹ç¨‹å¼ç¢¼æ²’æœ‰å€åˆ†è¨Šæ¯ä¾†æºé¡å‹ï¼ˆä¸€å°ä¸€ vs ç¾¤çµ„ï¼‰
2. **ç„¡ mention æª¢æ¸¬æ©Ÿåˆ¶**: æ²’æœ‰æª¢æŸ¥ç¾¤çµ„è¨Šæ¯æ˜¯å¦çœŸæ­£é‡å° bot
3. **è¨»å†Šé‚è¼¯éæ–¼ç©æ¥µ**: å°æ‰€æœ‰æœªè¨»å†Šç”¨æˆ¶éƒ½æœƒä¸»å‹•ç™¼é€è¨»å†Šè¨Šæ¯

## âœ… ä¿®å¾©æ–¹æ¡ˆ

### 1. æ–°å¢ç¾¤çµ„è¡Œç‚ºé…ç½®æ¨¡çµ„ (`bot_config.py`)

```python
class BotConfig:
    def __init__(self):
        self.bot_name = os.environ.get('BOT_NAME', 'assistant')
        self.mention_patterns = [f'@{self.bot_name}', '@assistant']
        self.group_allowed_commands = ['/health', '/å¥åº·æª¢æŸ¥', '/help', '/èªªæ˜']
        self.unregistered_allowed_commands = ['/health', '/å¥åº·æª¢æŸ¥', '/è¨»å†Š', '/help', '/èªªæ˜']
    
    def should_respond_in_group(self, message_text):
        """åˆ¤æ–·æ˜¯å¦æ‡‰è©²åœ¨ç¾¤çµ„ä¸­å›æ‡‰æ­¤è¨Šæ¯"""
        command = message_text.split(' ')[0]
        return (self.is_bot_mentioned(message_text) or 
                self.is_group_allowed_command(command))
```

### 2. ä¿®æ”¹ä¸»è¦è¨Šæ¯è™•ç†é‚è¼¯ (`main.py`)

#### A. æ–°å¢ä¾†æºé¡å‹æª¢æ¸¬
```python
source_type = event.source.type  # 'user', 'group', 'room'
group_id = getattr(event.source, 'group_id', None) if source_type == 'group' else None
```

#### B. ç¾¤çµ„è¨Šæ¯éæ¿¾
```python
if source_type in ['group', 'room']:
    if not bot_config.should_respond_in_group(message_text):
        print(f"ç¾¤çµ„è¨Šæ¯æœªæ»¿è¶³å›æ‡‰æ¢ä»¶ï¼Œå¿½ç•¥è™•ç†: {message_text}")
        return  # ä¸è™•ç†ä¸ç¬¦åˆæ¢ä»¶çš„ç¾¤çµ„è¨Šæ¯
```

#### C. å·®ç•°åŒ–è¨»å†Šå¼•å°
```python
if not is_registered and not bot_config.is_unregistered_allowed_command(command_part):
    if source_type == 'user':  # åªåœ¨ä¸€å°ä¸€èŠå¤©ä¸­ç™¼é€è¨»å†Šå¼•å°
        send_registration_flex_message(reply_token, user_id)
    else:  # åœ¨ç¾¤çµ„ä¸­çµ¦å‡ºç°¡çŸ­æç¤º
        line_bot_api.reply_message(
            reply_token,
            TextSendMessage(text="è«‹å…ˆç§è¨Šæˆ‘å®Œæˆè¨»å†Šå¾Œå†ä½¿ç”¨æ­¤åŠŸèƒ½ ğŸ“")
        )
```

## ğŸ“‹ ä¿®å¾©å¾Œçš„è¡Œç‚ºè¦å‰‡

### ç¾¤çµ„ä¸­çš„è¨Šæ¯è™•ç†
| è¨Šæ¯é¡å‹ | æ˜¯å¦å›æ‡‰ | èªªæ˜ |
|----------|----------|------|
| `@assistant ä½ å¥½` | âœ… å›æ‡‰ | ç›´æ¥ mention bot |
| `@assistant /å¡«è¡¨` | âœ… å›æ‡‰ | mention + æŒ‡ä»¤ |
| `/health` | âœ… å›æ‡‰ | å…¬é–‹å¥åº·æª¢æŸ¥æŒ‡ä»¤ |
| `/help` | âœ… å›æ‡‰ | å…¬é–‹èªªæ˜æŒ‡ä»¤ |
| `/å¡«è¡¨` | âŒ å¿½ç•¥ | éœ€è¦ mention æˆ–ç§è¨Š |
| `å¤§å®¶å¥½` | âŒ å¿½ç•¥ | ä¸€èˆ¬èŠå¤©è¨Šæ¯ |
| `èª°èƒ½å¹«å¿™ï¼Ÿ` | âŒ å¿½ç•¥ | ç„¡æ˜ç¢ºæŒ‡å‘ bot |

### è¨»å†Šå¼•å°ç­–ç•¥
- **ä¸€å°ä¸€èŠå¤©**: ç™¼é€å®Œæ•´çš„è¨»å†Š Flex è¨Šæ¯
- **ç¾¤çµ„èŠå¤©**: åƒ…ç™¼é€ç°¡çŸ­æç¤ºï¼Œé¿å…æ‰“æ“¾å…¶ä»–æˆå“¡

## ğŸ§ª é©—è­‰æ¸¬è©¦

å»ºç«‹äº† `test_group_behavior.py` æ¸¬è©¦è…³æœ¬ï¼ŒåŒ…å«ï¼š
- ç¾¤çµ„è¨Šæ¯è™•ç†é‚è¼¯æ¸¬è©¦
- Mention ç§»é™¤åŠŸèƒ½æ¸¬è©¦  
- æŒ‡ä»¤æ¬Šé™æ¸¬è©¦

## ğŸ”§ é…ç½®æª”æ¡ˆèªªæ˜

### ç’°å¢ƒè®Šæ•¸ (`.env`)
```bash
BOT_NAME=assistant  # Bot çš„åç¨±ï¼Œç”¨æ–¼ mention æª¢æ¸¬
```

### ç¾¤çµ„å…è¨±æŒ‡ä»¤
ç„¡éœ€ mention å³å¯åœ¨ç¾¤çµ„ä¸­ä½¿ç”¨ï¼š
- `/health`, `/å¥åº·æª¢æŸ¥` - å¥åº·æª¢æŸ¥
- `/help`, `/èªªæ˜` - ä½¿ç”¨èªªæ˜

### æœªè¨»å†Šç”¨æˆ¶å…è¨±æŒ‡ä»¤
- `/health`, `/å¥åº·æª¢æŸ¥` - å¥åº·æª¢æŸ¥
- `/è¨»å†Š` - è¨»å†ŠåŠŸèƒ½
- `/help`, `/èªªæ˜` - ä½¿ç”¨èªªæ˜

## ğŸš€ éƒ¨ç½²å»ºè­°

1. **æ¸¬è©¦ç¾¤çµ„è¡Œç‚º**:
   ```bash
   cd /Volumes/M200/project/linebot
   python test_group_behavior.py
   ```

2. **æª¢æŸ¥é…ç½®**:
   - ç¢ºèª `.env` ä¸­ `BOT_NAME` è¨­å®šæ­£ç¢º
   - é©—è­‰ mention é—œéµå­—ç¬¦åˆå¯¦éš›ä½¿ç”¨

3. **ç›£æ§æ—¥èªŒ**:
   - è§€å¯Ÿç¾¤çµ„è¨Šæ¯éæ¿¾æ—¥èªŒ
   - ç¢ºèªåªæœ‰ç¬¦åˆæ¢ä»¶çš„è¨Šæ¯è¢«è™•ç†

## ğŸ“ˆ æ•ˆæœé æœŸ

- âœ… ç¾¤çµ„ä¸­ä¸å†æœ‰æœªç¶“è«‹æ±‚çš„è¨»å†Šæç¤º
- âœ… åªæœ‰è¢« mention æˆ–ä½¿ç”¨å…¬é–‹æŒ‡ä»¤æ™‚æ‰å›æ‡‰
- âœ… ä¿æŒä¸€å°ä¸€èŠå¤©çš„å®Œæ•´åŠŸèƒ½
- âœ… æ¸›å°‘ç¾¤çµ„æˆå“¡çš„å¹²æ“¾æ„Ÿå—
- âœ… æå‡ bot çš„å°ˆæ¥­å½¢è±¡

## ğŸ”„ å¾ŒçºŒå„ªåŒ–å»ºè­°

1. **æ™ºèƒ½ mention æª¢æ¸¬**: æ”¯æ´æ›´å¤š mention æ ¼å¼
2. **ç¾¤çµ„ç®¡ç†å“¡æ¬Šé™**: ç‰¹æ®Šæ¬Šé™è¨­å®š
3. **ä½¿ç”¨çµ±è¨ˆ**: è¨˜éŒ„ç¾¤çµ„äº’å‹•æ•¸æ“š
4. **è‡ªé©æ‡‰å›æ‡‰**: æ ¹æ“šç¾¤çµ„æ´»èºåº¦èª¿æ•´å›æ‡‰ç­–ç•¥

---

**ä¿®å¾©å®Œæˆæ™‚é–“**: 2025-06-05  
**å½±éŸ¿ç¯„åœ**: ç¾¤çµ„è¨Šæ¯è™•ç†ã€è¨»å†Šæµç¨‹  
**æ¸¬è©¦ç‹€æ…‹**: âœ… é€šé  
**éƒ¨ç½²ç‹€æ…‹**: ğŸŸ¡ å¾…éƒ¨ç½²
